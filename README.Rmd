---
title: "IPA R Package User Manual"
author: "Sam Shen, Jian Guo, Tao Huan"
date: "07/04/2021"
# output: html_document
always_allow_html: true
output:
  github_document:
    toc: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(error = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
```

# Part 1: Introduction and Installation
`IPA` is an R package for identifying level 3 features and performing integrated feature extraction and annotation. The package is written in the language R and its source code is publicly available at https://github.com/HuanLab/IPA.git.

To install `ISFrag` package R version 4.0.0 or above is required, and we recommend using RStudio to complete the installation and usage of `ISFrag` by following the steps below:
```{r, eval=TRUE}
# Install "BiocManager" package from CRAN if you do not already have it installed.
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

# Install "devtools" package from CRAN if you do not already have it installed.
if (!requireNamespace("devtools", quietly = TRUE)){
    install.packages("devtools")
}

# Load "devtools" package.
library(devtools)

# Install "ISFrag" from Github using "devtools".
if (!requireNamespace("ISFrag", quietly = TRUE)){
  install_github("HuanLab/IPA")
}

# Load "IPA" package.
library(IPA)
```

# Part 2: MS1 level 1 & 2 Feature Extraction
`IPA` supports multiple ways to generate an MS1 featuretable and to label features as either level 1 or 2. Users can choose to use `XCMS` to extract features from mzXML files (Section 2.1) or upload their own featuretable in csv format generated by other commonly used data processing software (Section 2.2). For the rest of the tutorial, to view details and additional parameters of functions, type: `help("<function name>")`. Note: for multi-sample analysis, sample alignment is performed after level 3 and target features have been identified. It will be discussed in section 5. 

## 2.1 XCMS Feature Extraction
One or multiple mzXML files from DDA analyses can be analyzed at once using XCMS to extract MS1 level 1 & 2 features. All mzXML file(s) need to be placed in a separate folder containing no other irrelevant mzXML files. Additional details of XCMS algorithm is available at their official website at: https://rdrr.io/bioc/xcms/man/.
```{r, eval=TRUE}
# dir specifies the full directory of the folder containing mzXML file(s).
dir = "X:/Users/Sam_Shen/IPAtest_20210330/multiDDA"

# The XCMS.featureTable() function outputs a dataframe formatted featuretable as well as an MSnbase object.
# The "level" column shows the level of each feature.
featureTable <- XCMS.featureTable(dir = dir, mz.tol = 10, ppm=10, peakwidth=c(5,20), mzdiff = 0.01,
                             snthresh = 6, integrate = 1, prefilter = c(3,100), noise = 100)
head(featureTable)
```

## 2.2 Custom Featuretable Input
When using a custom featuretable (eg. from MS-DIAL, MZmine2, etc) for `IPA` analyses, in order for `IPA` to successfully read the provided CSV file, it must contain only columns in the following order: m/z, retention time, min retention time, max retention time, intensity. For multi-sample analysis, a CSV feature table needs to be provided for each single mzXML file to be analyzed. Aligned feature table is not acceptable. All CSV file(s) of interest need to be placed in a separate folder containing no other irrelevant CSV files. Note: column 3 and column 4 are the retention time of the feature edges, and all three columns containing retention time information should be in seconds.
```{r, eval=TRUE}
# ft_directory specifies the directory of the custom csv file(s).
FTdir = "X:/Users/Sam_Shen/IPAtest_20210330/multiDDA"
# dir specifies the full directory of the folder containing mzXML file(s).
dir = "X:/Users/Sam_Shen/IPAtest_20210330/multiDDA"

# Sample csv feature table.
setwd(FTdir)
head(read.csv(list.files(pattern = ".csv")[1], header = T, stringsAsFactors = F))

# The custom.featureTable() function outputs a dataframe formatted featuretable as well as an MSnbase object.
# The "level" column shows the level of each feature.
featureTable <- custom.featureTable(dir = dir, FTdir = FTdir)
head(featureTable)
```

# Part 3: Level 3 Feature Identification
After level 1 and 2 features have been extracted, level 3 feature identification can be performed. This step is optional.
```{r, eval=TRUE}
# Find level 3 features and add them to the original feature table.
featureTable <- find.level3features(data = MSdata)
```

# Part 4: Add Target Features
After extracting all level 1, 2, and 3 features, users may also want to extract features from an in-house library of standard metabolites with given mass and retention time information. If these features already exists in the original feature table as either level 1, 2, or 3 features, they will not be added. Otherwise, these features will be explored from the raw data and added to the feature table with "target" as their level if exist. The in-house metabolites library must be in CSV format with ONLY the columns "mz" and "rt" in order. This step is optional.
```{r, eval=TRUE}
# Directory containing the in-house standard metabolite library.
tarFTdir = "X:/Users/Sam_Shen/IPAtest_20210330"
# Name of the in-house standard metabolite library in CSV format.
tarFTname = "LibraryCSVHILIC-.csv"

# Sample format of in-house standard metabolite library.
setwd(tarFTdir)
head(read.csv(tarFTname, header = T, stringsAsFactors = F))

# Extract target feature and add them to the original featuretable if they do no exist already.
featureTable <- find.targetfeatures(data = MSdata, tarFTdir = tarFTdir, tarFTname = tarFTname)
# Target features that are newly added.
head(featureTable[featureTable$level == "target",])
```

# Part 5: Sample Alignment
For multi-sample analysis, sample alignment is performed after all level 1, 2, 3, and target features have been identified. Do not perform sample alignment for single-sample analysis.
```{r, eval=TRUE}
# Update feature table to aligned feature table for multi-sample analysis.
featureTable <- peak.alignment(data = MSdata, bw = 5, minfrac = 0.5, mzwid = 0.015,
                               minsamp = 1, max = 100, quantitative.method = "maxo")
head(featureTable)
```

# Part 6: MS2 Annotation
Feature annotation is performed by two functions: "ms2.tofeaturetable" for assigning MS2 to each corresponding feature, and then "feature.annotation" for comparing each MS2 against a standard MS2 library for spectra similarity based metabolite annotation. The standard library used to perform annotation must be in msp format.
```{r, eval=TRUE}
# The ms2.tofeaturetable() function assigns MS2 spectra to the MS1 feature table. It returns a new feature table with additional columns containing MS2 fragment information.
featureTable <- ms2.tofeaturetable(data = MSdata, featureTable = featureTable)

# Now, use the feature.annotation() function to annotate features in the feature table against a standard database in msp format. This functions returns a feature table containing additional columns with annotation information.
lib_directory <- "X:/Users/Sam_Shen/Library" # directory containing the library file
lib_name <- "convertedLibraryNeg.msp" # name of the library file
featureTable <- feature.annotation(featureTable = featureTable, lib_directory = lib_directory, lib_name = lib_name, dp = 0.1)
# Display some annotated features.
head(featureTable[featureTable$Annotation != "unknown",])
```

# Part 7: Export EIC
EICs can be exported for all level 1, 2, 3, target, or aligned features individually. For multi-sample analysis, if users want to export level 1, 2, 3, or target features' EIC separately, then this step must be performed before sample alignment. Otherwise, only aligned features' EIC can be exported because the information of level 1, 2, 3 and target will not remain in the aligned feature table.
```{r, eval=FALSE}
# Directory to export EICs to.
plotdir <- "X:/Users/Sam_Shen/IPAtest_20210330"

# Draw and export EICs of all level 1 features.
plot.features(dir = plotdir, featureTable = featureTable, data = MSdata, plot.type = 1, smooth = 2)
# Draw and export EICs of all level 2 features.
plot.features(dir = plotdir, featureTable = featureTable, data = MSdata, plot.type = 2, smooth = 2)
# Draw and export EICs of all level 3 features.
plot.features(dir = plotdir, featureTable = featureTable, data = MSdata, plot.type = 3, smooth = 2)
# Draw and export EICs of all level target features.
plot.features(dir = plotdir, featureTable = featureTable, data = MSdata, plot.type = "target", smooth = 2)

# ONLY for multi-sample analysis AND after alignment, draw and export EICs of all aligned features.
plot.features(dir = plotdir, featureTable = featureTable, data = MSdata, plot.type = "multi", smooth = 2)
```

# Part 8: CAMERA Annotation
At the end of the IPA workflow, users can use CAMERA to identify adduct and isotope relationships in the feature table. Note: CAMERA annotation can ONLY be used for single-sample `IPA` analysis.
```{r, eval=FALSE}
# Perform CAMERA annotation.
featureTable <- adduct.isotope.annotation(featureTable = featureTable, data = MSdata, polarity = "negative")
```

# Part 9: Additional Details and Notes

